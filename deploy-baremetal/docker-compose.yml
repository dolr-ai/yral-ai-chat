services:

  yral-ai-chat:
    image: ${APP_IMAGE:-ghcr.io/dolr-ai/yral-ai-chat}:${IMAGE_TAG:-latest}
    restart: unless-stopped
    environment:
      # === Application Settings ===
      APP_NAME: "Yral AI Chat API"
      APP_VERSION: "1.0.0"
      HOST: "0.0.0.0"
      PORT: "8000"
      LOG_LEVEL: "info"
      LOG_FORMAT: "json"

      # === Database ===
      DATABASE_PATH: "/app/data/yral_chat.db"

      # === JWT Authentication ===
      JWT_SECRET_KEY: ${JWT_SECRET_KEY}
      JWT_ALGORITHM: "HS256"
      JWT_ISSUER: "yral_auth"

      # === Google Gemini API ===
      GEMINI_API_KEY: ${GEMINI_API_KEY}
      GEMINI_MODEL: ${GEMINI_MODEL:-gemini-2.5-flash}
      GEMINI_MAX_TOKENS: ${GEMINI_MAX_TOKENS:-2048}
      GEMINI_TEMPERATURE: ${GEMINI_TEMPERATURE:-0.7}

      # === OpenRouter API (NSFW content) ===
      OPENROUTER_API_KEY: ${OPENROUTER_API_KEY}
      OPENROUTER_MODEL: ${OPENROUTER_MODEL:-google/gemini-2.5-flash}

      # === Replicate (Image Generation) ===
      REPLICATE_API_TOKEN: ${REPLICATE_API_TOKEN}
      REPLICATE_MODEL: ${REPLICATE_MODEL:-black-forest-labs/flux-dev}

      # === S3 Configuration ===
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
      AWS_S3_BUCKET: ${AWS_S3_BUCKET}
      AWS_REGION: ${AWS_REGION:-us-east-1}
      S3_ENDPOINT_URL: ${S3_ENDPOINT_URL}
      S3_PUBLIC_URL_BASE: ${S3_PUBLIC_URL_BASE}

      # === Push Notifications ===
      METADATA_URL: ${METADATA_URL:-https://metadata.yral.com}
      YRAL_METADATA_NOTIFICATION_API_KEY: ${YRAL_METADATA_NOTIFICATION_API_KEY}

      # === CORS ===
      CORS_ORIGINS: ${CORS_ORIGINS:-*}

      # === Litestream (SQLite Replication) ===
      ENABLE_LITESTREAM: ${ENABLE_LITESTREAM:-true}
      LITESTREAM_ACCESS_KEY_ID: ${LITESTREAM_ACCESS_KEY_ID}
      LITESTREAM_SECRET_ACCESS_KEY: ${LITESTREAM_SECRET_ACCESS_KEY}
      LITESTREAM_BUCKET: ${LITESTREAM_BUCKET}
      LITESTREAM_ENDPOINT: ${LITESTREAM_ENDPOINT}
      LITESTREAM_REGION: ${LITESTREAM_REGION}
      LITESTREAM_PATH: ${LITESTREAM_PATH:-yral-ai-chat/db}
    volumes:
      - app_data:/app/data
    networks:
      - ai-chat-net
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://127.0.0.1:8000/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  caddy:
    image: caddy:2-alpine
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
      - "443:443/udp"  # HTTP/3 QUIC support
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    networks:
      - ai-chat-net
    depends_on:
      yral-ai-chat:
        condition: service_healthy

networks:
  ai-chat-net:
    driver: bridge

volumes:
  app_data:
  caddy_data:
  caddy_config:
