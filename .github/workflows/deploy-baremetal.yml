name: Deploy to Bare Metal Servers

on:
  workflow_dispatch:
  push:
    branches:
      - main

concurrency:
  group: deploy-baremetal-${{ github.ref }}
  cancel-in-progress: false

env:
  DOCKER_REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build_check:
    uses: ./.github/workflows/build-check.yml
    with:
      publish-artifact: true
    secrets: inherit

  security-scan:
    name: Security Scan
    needs: build_check
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: build-glibc

      - name: Make binary executable
        run: chmod +x target/x86_64-unknown-linux-gnu/release/yral-ai-chat

      - name: Build image for scanning
        run: docker build -f deploy-baremetal/Dockerfile -t yral-ai-chat:${{ github.sha }} .

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: "yral-ai-chat:${{ github.sha }}"
          format: "table"
          exit-code: "1"
          ignore-unfixed: true
          vuln-type: "os,library"
          severity: "CRITICAL,HIGH"

  build-and-push:
    name: Build and Push Docker Image
    needs: [build_check, security-scan]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    outputs:
      image_tag: ${{ github.sha }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: build-glibc

      - name: Make binary executable
        run: chmod +x target/x86_64-unknown-linux-gnu/release/yral-ai-chat

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.DOCKER_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=sha,format=long,prefix=
            type=raw,value=latest

      - name: Build and push image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./deploy-baremetal/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  prepare-servers:
    name: Prepare Server List
    runs-on: ubuntu-latest
    outputs:
      servers: ${{ steps.parse.outputs.servers }}
    steps:
      - name: Parse server IPs
        id: parse
        run: |
          IPS="${{ secrets.BAREMETAL_SERVER_IPS }}"
          JSON=$(echo "$IPS" | tr ',' '\n' | jq -R . | jq -s -c .)
          echo "servers=$JSON" >> $GITHUB_OUTPUT

  deploy:
    name: Deploy to Server
    needs: [build-and-push, prepare-servers]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        server: ${{ fromJson(needs.prepare-servers.outputs.servers) }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.HETZNER_BARE_METAL_GITHUB_ACTIONS_SSH_PRIVATE_KEY }}

      - name: Add server to known hosts
        run: |
          ssh-keyscan -H ${{ matrix.server }} >> ~/.ssh/known_hosts

      - name: Check server connectivity
        run: |
          ssh -o ConnectTimeout=10 root@${{ matrix.server }} "echo 'Server ${{ matrix.server }} connection successful'"

      - name: Sync deployment files to server
        run: |
          rsync -avz --delete \
            ./deploy-baremetal/ \
            root@${{ matrix.server }}:/home/yral-ai-chat/

      - name: Log in to GHCR on server
        run: |
          ssh root@${{ matrix.server }} "
            echo '${{ secrets.GITHUB_TOKEN }}' | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          "

      - name: Deploy with Docker Compose
        run: |
          ssh root@${{ matrix.server }} "
            cd /home/yral-ai-chat

            echo 'Pulling latest images...'
            APP_IMAGE=ghcr.io/${{ github.repository }} \
            IMAGE_TAG=${{ github.sha }} \
            docker compose pull yral-ai-chat

            echo 'Stopping existing containers...'
            docker compose down --remove-orphans || true

            echo 'Starting services...'
            APP_IMAGE=ghcr.io/${{ github.repository }} \
            IMAGE_TAG=${{ github.sha }} \
            JWT_SECRET_KEY='${{ secrets.JWT_SECRET_KEY }}' \
            GEMINI_API_KEY='${{ secrets.GEMINI_API_KEY }}' \
            GEMINI_MODEL='gemini-2.5-flash' \
            GEMINI_MAX_TOKENS='2048' \
            GEMINI_TEMPERATURE='0.7' \
            OPENROUTER_API_KEY='${{ secrets.OPENROUTER_API_KEY }}' \
            OPENROUTER_MODEL='${{ secrets.OPENROUTER_MODEL }}' \
            REPLICATE_API_TOKEN='${{ secrets.REPLICATE_API_TOKEN }}' \
            REPLICATE_MODEL='black-forest-labs/flux-dev' \
            AWS_ACCESS_KEY_ID='${{ secrets.AWS_ACCESS_KEY_ID }}' \
            AWS_SECRET_ACCESS_KEY='${{ secrets.AWS_SECRET_ACCESS_KEY }}' \
            AWS_S3_BUCKET='${{ secrets.AWS_S3_BUCKET }}' \
            AWS_REGION='${{ secrets.AWS_REGION }}' \
            S3_ENDPOINT_URL='${{ secrets.S3_ENDPOINT_URL }}' \
            S3_PUBLIC_URL_BASE='${{ secrets.S3_PUBLIC_URL_BASE }}' \
            METADATA_URL='https://metadata.yral.com' \
            YRAL_METADATA_NOTIFICATION_API_KEY='${{ secrets.YRAL_METADATA_NOTIFICATION_API_KEY }}' \
            CORS_ORIGINS='${{ secrets.CORS_ORIGINS }}' \
            ENABLE_LITESTREAM='true' \
            LITESTREAM_ACCESS_KEY_ID='${{ secrets.LITESTREAM_ACCESS_KEY_ID }}' \
            LITESTREAM_SECRET_ACCESS_KEY='${{ secrets.LITESTREAM_SECRET_ACCESS_KEY }}' \
            LITESTREAM_BUCKET='${{ secrets.LITESTREAM_BUCKET }}' \
            LITESTREAM_ENDPOINT='${{ secrets.LITESTREAM_ENDPOINT }}' \
            LITESTREAM_REGION='${{ secrets.LITESTREAM_REGION }}' \
            LITESTREAM_PATH='yral-ai-chat/production' \
            docker compose up -d

            echo 'Waiting for services to start...'
            sleep 15

            echo 'Services status:'
            docker compose ps
          "

      - name: Verify deployment
        run: |
          ssh root@${{ matrix.server }} "
            cd /home/yral-ai-chat
            echo '=== Container Status ==='
            docker compose ps
            echo ''
            echo '=== Health Check ==='
            for i in 1 2 3 4 5 6 7 8 9 10; do
              if curl -sf http://127.0.0.1:8000/health > /dev/null 2>&1; then
                echo 'Health check passed!'
                exit 0
              fi
              echo \"Attempt \$i/10 failed, retrying in 3s...\"
              sleep 3
            done
            echo 'Health check failed after 10 attempts'
            echo '=== Container Logs (last 30 lines) ==='
            docker compose logs --tail=30 yral-ai-chat 2>/dev/null || echo 'Logs not yet available'
            exit 1
          "

  deployment-summary:
    name: Deployment Summary
    needs: [deploy]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Deployment summary
        run: |
          echo "## Bare Metal Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployment Status: ${{ needs.deploy.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Image" >> $GITHUB_STEP_SUMMARY
          echo "- ghcr.io/${{ github.repository }}:${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Services" >> $GITHUB_STEP_SUMMARY
          echo "- yral-ai-chat (HTTP + WebSocket service on port 8000)" >> $GITHUB_STEP_SUMMARY
          echo "- caddy (TLS termination + HTTP/2/HTTP/3 reverse proxy)" >> $GITHUB_STEP_SUMMARY
