name: Deploy PR Preview

on:
  pull_request:
    types: [opened, reopened, synchronize, closed]

permissions:
  deployments: write

env:
  FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
  FLY_ORG: gobazzinga-inc-584

jobs:
  build_check:
    uses: ./.github/workflows/build-check.yml
    with:
      publish-artifact: true

  preview:
    needs: build_check
    runs-on: ubuntu-latest

    concurrency:
      group: pr-${{ github.event.number }}

    outputs:
      url: ${{ steps.deploy.outputs.url }}

    environment:
      name: pr-${{ github.event.number }}
      url: ${{ steps.deploy.outputs.url }}

    steps:
      - uses: actions/checkout@v4

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: build-glibc

      - name: Make binary executable
        run: chmod +x target/x86_64-unknown-linux-gnu/release/yral-ai-chat

      - name: Deploy PR preview app
        id: deploy
        uses: superfly/fly-pr-review-apps@1.2.1
        env:
          FLYCTL_VERSION: v0.3.144

      - uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Set secrets
        if: ${{ github.event.pull_request.merged == false }}
        run: |
          APP_NAME="pr-${{ github.event.number }}-${{ github.repository_owner }}-yral-ai-chat"
          flyctl secrets set "JWT_SECRET_KEY=$JWT_SECRET_KEY" --app "$APP_NAME" --stage
          flyctl secrets set "GEMINI_API_KEY=$GEMINI_API_KEY" --app "$APP_NAME" --stage
          flyctl secrets set "GEMINI_MODEL=gemini-2.5-flash" --app "$APP_NAME" --stage
          flyctl secrets set "GEMINI_MAX_TOKENS=2048" --app "$APP_NAME" --stage
          flyctl secrets set "GEMINI_TEMPERATURE=0.7" --app "$APP_NAME" --stage
          flyctl secrets set "OPENROUTER_API_KEY=$OPENROUTER_API_KEY" --app "$APP_NAME" --stage
          flyctl secrets set "OPENROUTER_MODEL=$OPENROUTER_MODEL" --app "$APP_NAME" --stage
          flyctl secrets set "REPLICATE_API_TOKEN=$REPLICATE_API_TOKEN" --app "$APP_NAME" --stage
          flyctl secrets set "REPLICATE_MODEL=black-forest-labs/flux-dev" --app "$APP_NAME" --stage
          flyctl secrets set "AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID" --app "$APP_NAME" --stage
          flyctl secrets set "AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY" --app "$APP_NAME" --stage
          flyctl secrets set "AWS_S3_BUCKET=$AWS_S3_BUCKET" --app "$APP_NAME" --stage
          flyctl secrets set "AWS_REGION=$AWS_REGION" --app "$APP_NAME" --stage
          flyctl secrets set "S3_ENDPOINT_URL=$S3_ENDPOINT_URL" --app "$APP_NAME" --stage
          flyctl secrets set "S3_PUBLIC_URL_BASE=$S3_PUBLIC_URL_BASE" --app "$APP_NAME" --stage
          flyctl secrets set "METADATA_URL=https://metadata.yral.com" --app "$APP_NAME" --stage
          flyctl secrets set "YRAL_METADATA_NOTIFICATION_API_KEY=$YRAL_METADATA_NOTIFICATION_API_KEY" --app "$APP_NAME" --stage
          flyctl secrets set "CORS_ORIGINS=$CORS_ORIGINS" --app "$APP_NAME" --stage
          flyctl secrets set "ENABLE_LITESTREAM=true" --app "$APP_NAME" --stage
          flyctl secrets set "LITESTREAM_ACCESS_KEY_ID=$LITESTREAM_ACCESS_KEY_ID" --app "$APP_NAME" --stage
          flyctl secrets set "LITESTREAM_SECRET_ACCESS_KEY=$LITESTREAM_SECRET_ACCESS_KEY" --app "$APP_NAME" --stage
          flyctl secrets set "LITESTREAM_BUCKET=$LITESTREAM_BUCKET" --app "$APP_NAME" --stage
          flyctl secrets set "LITESTREAM_ENDPOINT=$LITESTREAM_ENDPOINT" --app "$APP_NAME" --stage
          flyctl secrets set "LITESTREAM_REGION=$LITESTREAM_REGION" --app "$APP_NAME" --stage
          flyctl secrets set "LITESTREAM_PATH=yral-ai-chat/pr-${{ github.event.number }}" --app "$APP_NAME" --stage
          flyctl deploy --app "$APP_NAME"
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
          JWT_SECRET_KEY: ${{ secrets.JWT_SECRET_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          OPENROUTER_MODEL: ${{ secrets.OPENROUTER_MODEL }}
          REPLICATE_API_TOKEN: ${{ secrets.REPLICATE_API_TOKEN }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_S3_BUCKET: ${{ secrets.AWS_S3_BUCKET }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
          S3_ENDPOINT_URL: ${{ secrets.S3_ENDPOINT_URL }}
          S3_PUBLIC_URL_BASE: ${{ secrets.S3_PUBLIC_URL_BASE }}
          YRAL_METADATA_NOTIFICATION_API_KEY: ${{ secrets.YRAL_METADATA_NOTIFICATION_API_KEY }}
          CORS_ORIGINS: ${{ secrets.CORS_ORIGINS }}
          LITESTREAM_ACCESS_KEY_ID: ${{ secrets.LITESTREAM_ACCESS_KEY_ID }}
          LITESTREAM_SECRET_ACCESS_KEY: ${{ secrets.LITESTREAM_SECRET_ACCESS_KEY }}
          LITESTREAM_BUCKET: ${{ secrets.LITESTREAM_BUCKET }}
          LITESTREAM_ENDPOINT: ${{ secrets.LITESTREAM_ENDPOINT }}
          LITESTREAM_REGION: ${{ secrets.LITESTREAM_REGION }}

  integration_tests:
    needs: preview
    if: ${{ github.event.action != 'closed' && needs.preview.outputs.url != '' }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Rust Setup
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: stable

      - name: Use rust cache
        uses: Swatinem/rust-cache@v2

      - name: Wait for preview to be healthy
        run: |
          URL="${{ needs.preview.outputs.url }}"
          echo "Waiting for $URL/health to be healthy..."
          for i in $(seq 1 30); do
            if curl -sf "$URL/health" > /dev/null 2>&1; then
              echo "Preview is healthy!"
              exit 0
            fi
            echo "Attempt $i/30 - not ready yet, waiting 10s..."
            sleep 10
          done
          echo "Preview failed to become healthy after 5 minutes"
          exit 1

      - name: Run integration tests
        env:
          TEST_API_URL: ${{ needs.preview.outputs.url }}
        run: cargo test --test health --test auth --test influencers --test chat --test chat_v2 --test websocket --test rate_limit -- --test-threads=1
