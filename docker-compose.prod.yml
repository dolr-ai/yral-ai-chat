services:
  yral-ai-chat:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: yral-ai-chat
    restart: unless-stopped
    stop_grace_period: 30s
    ports:
      - "8000:8000"
    volumes:
      # Persist SQLite database
      - ./data:/app/data
      # Persist logs
      - ./logs:/app/logs
      # Note: Media files are stored in S3, not locally
    shm_size: '2gb'
    deploy:
      resources:
        reservations:
          memory: 2G
    environment:
      # Application Settings
      - APP_NAME=${APP_NAME:-Yral AI Chat API}
      - APP_VERSION=${APP_VERSION:-1.0.0}
      - ENVIRONMENT=${PRODUCTION_ENV:-production}
      - DEBUG=${DEBUG:-False}
      - HOST=0.0.0.0
      - PORT=8000

      # Database (SQLite)
      - DATABASE_PATH=${DATABASE_PATH:-/app/data/yral_chat.db}

      # JWT Authentication (REQUIRED)
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
      - JWT_ALGORITHM=${JWT_ALGORITHM:-HS256}
      - JWT_ISSUER=${JWT_ISSUER:-yral_auth}

      # Google Gemini API (REQUIRED)
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - GEMINI_MODEL=${GEMINI_MODEL:-gemini-2.5-flash}
      - GEMINI_MAX_TOKENS=${GEMINI_MAX_TOKENS:-2048}
      - GEMINI_TEMPERATURE=${GEMINI_TEMPERATURE:-0.7}

      # OpenRouter API
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY}
      - OPENROUTER_MODEL=${OPENROUTER_MODEL:-google/gemini-2.5-flash}

      # Media Storage - S3 (Required)
      - MAX_IMAGE_SIZE_MB=${MAX_IMAGE_SIZE_MB:-10}
      - MAX_AUDIO_SIZE_MB=${MAX_AUDIO_SIZE_MB:-20}
      - MAX_AUDIO_DURATION_SECONDS=${MAX_AUDIO_DURATION_SECONDS:-300}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_S3_BUCKET=${AWS_S3_BUCKET}
      - AWS_REGION=${AWS_REGION}
      - S3_ENDPOINT_URL=${S3_ENDPOINT_URL}
      - S3_PUBLIC_URL_BASE=${S3_PUBLIC_URL_BASE}

      # Optional: Whisper API
      - USE_WHISPER=${USE_WHISPER:-false}
      - WHISPER_API_KEY=${WHISPER_API_KEY:-}

      # CORS Configuration
      - CORS_ORIGINS=${CORS_ORIGINS:-*}
      - CORS_ALLOW_CREDENTIALS=${CORS_ALLOW_CREDENTIALS:-true}

      # Rate Limiting
      - RATE_LIMIT_PER_MINUTE=${RATE_LIMIT_PER_MINUTE:-60}
      - RATE_LIMIT_PER_HOUR=${RATE_LIMIT_PER_HOUR:-1000}

      # Logging
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - LOG_FORMAT=${LOG_FORMAT:-json}

      # Sentry Error Tracking & Performance Monitoring
      - SENTRY_DSN=${SENTRY_DSN:-}
      - SENTRY_TRACES_SAMPLE_RATE=${SENTRY_TRACES_SAMPLE_RATE:-1.0}
      - SENTRY_PROFILES_SAMPLE_RATE=${SENTRY_PROFILES_SAMPLE_RATE:-0.0}
      - SENTRY_WEBHOOK_SECRET=${SENTRY_WEBHOOK_SECRET}
      - GOOGLE_CHAT=${GOOGLE_CHAT}

      # Litestream Configuration
      - ENABLE_LITESTREAM=${ENABLE_LITESTREAM:-false}
      - LITESTREAM_ACCESS_KEY_ID=${LITESTREAM_ACCESS_KEY_ID}
      - LITESTREAM_SECRET_ACCESS_KEY=${LITESTREAM_SECRET_ACCESS_KEY}
      - LITESTREAM_BUCKET=${LITESTREAM_BUCKET}
      - LITESTREAM_ENDPOINT=${LITESTREAM_ENDPOINT}
      - LITESTREAM_REGION=${LITESTREAM_REGION}
    healthcheck:
      test: [ "CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  nginx:
    image: nginx:alpine
    container_name: yral-ai-chat-nginx
    restart: unless-stopped
    network_mode: host
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/rate-limit-zones.conf:/etc/nginx/conf.d/rate-limit-zones.conf:ro
      - ./nginx/yral-ai-chat.conf:/etc/nginx/conf.d/default.conf:ro
      - /opt/nginx-certs/letsencrypt:/etc/letsencrypt:ro
      - ./logs/nginx:/var/log/nginx
    depends_on:
      - yral-ai-chat
    healthcheck:
      test: [ "CMD", "nginx", "-t" ]
      interval: 30s
      timeout: 10s
      retries: 3

  # Metabase BI Dashboard - Production
  # Accessible at: https://chat.yral.com/metabase/
  # Reads SQLite databases from ./data directory (read-only)
  metabase:
    image: metabase/metabase:latest
    container_name: yral-ai-chat-metabase
    restart: unless-stopped
    ports:
      - "3000:3000"
    volumes:
      # Mount SQLite databases for read-only access
      - ./data:/data:ro
      # Persist Metabase metadata (dashboards, queries, settings)
      - metabase-data:/metabase-data
    environment:
      - MB_DB_TYPE=h2
      - MB_DB_FILE=/metabase-data/metabase.db
      - JAVA_TIMEZONE=UTC
      - MB_SITE_URL=https://chat.yral.com/metabase
      - JAVA_OPTS=-Xmx2g -Xms1g
      - MB_JDBC_DATA_SOURCE_MAX_CONNECTION_POOL_SIZE=15
    healthcheck:
      test: [ "CMD-SHELL", "pgrep -f 'java.*metabase' > /dev/null || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Beszel Monitoring Agent
  beszel-agent:
    image: henrygd/beszel-agent
    container_name: beszel-agent
    restart: unless-stopped
    network_mode: host
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./beszel_agent_data:/var/lib/beszel-agent
    environment:
      LISTEN: ${BESZEL_LISTEN_PORT:-45876}
      KEY: ${BESZEL_KEY}
      TOKEN: ${BESZEL_TOKEN}
      HUB_URL: ${BESZEL_HUB_URL:-https://beszel.yral.com}

volumes:
  # Metabase metadata storage (dashboards, queries, settings)
  metabase-data:
    driver: local
